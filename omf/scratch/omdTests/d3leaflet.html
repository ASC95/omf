<!DOCTYPE html>
<html>
<head>
	<title>Leaflet with SVG</title>

    <link 
        rel="stylesheet" 
        href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"
    />
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script
        src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js">
    </script>
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map{
        position: relative;
        width: 100.0%;
        height: 100.0%;
        left: 0.0%;
        top: 0.0%;
        }
    </style>
    
</head>
<body>
	<div id="map"></div>

	<script type="text/javascript">
	
        var map = L.map('map').setView([32.9858360538, -102.760659987], 13);
        mapLink = 
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 19,
            }).addTo(map);
				
	//Initialize the SVG layer
	map._initPathRoot()    

	var svg = d3.select("#map").select("svg"),
	g = svg.append("g");
	
	d3.json("nodes.json", function(collection) {
		collection.objects.forEach(function(d) {
			d.LatLng = new L.LatLng(d.circle.coordinates[0],
									d.circle.coordinates[1])
		})
		
		//Set nodes
		var feature = g.selectAll("circle")
			.data(collection.objects)
			.enter().append("circle")
			.style("stroke", "black")  
			.style("opacity", .6) 
			.style("fill", "red")
			.attr("r", 5);  
		
		map.on("viewreset", update);
		update();

		//Scale node position with pan and zoom 
		function update() {
			feature.attr("cx", 
			function(d) { 
				return map.latLngToLayerPoint(d.LatLng).x;
				}
			);
			feature.attr("cy", 
			function(d) { 
				return  map.latLngToLayerPoint(d.LatLng).y;
				}
			);
		}
	});
	d3.json("lines.json", function(collection) {
		collection.objects.forEach(function(l) {
			l.latLngStart = new L.LatLng(l.line.coordinates[0][0], l.line.coordinates[0][1]);
			l.latLngEnd = new L.LatLng(l.line.coordinates[1][0], l.line.coordinates[1][1]);
		})
		
		var linefeature = g.selectAll("line")
			.data(collection.objects)
			.enter().append("line")
			.style("stroke", "blue");
		
		map.on("viewreset", updateLine);
		updateLine();

		//Scale lines with pan and zoom
		function updateLine() {
			linefeature.attr("x1",
			function(l) {
				console.log(l.latLngBounds);
				return map.latLngToLayerPoint(l.latLngStart).x;
				}
			);
			linefeature.attr("y1",
			function(l) {
				return map.latLngToLayerPoint(l.latLngStart).y;
				}
			);
			linefeature.attr("x2",
			function(l) {
				return map.latLngToLayerPoint(l.latLngEnd).x;;
				}
			);
			linefeature.attr("y2",
			function(l) {
				return map.latLngToLayerPoint(l.latLngEnd).y;
				}
			);
		}
	});
</script>
</body>
</html>