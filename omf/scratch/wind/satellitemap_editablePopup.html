<!DOCTYPE html>
<html>
<head>
	<title>GeoJSON Map</title>
<head>
	<link rel='stylesheet' href='https://unpkg.com/leaflet@1.0.3/dist/leaflet.css' integrity='sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=='
		crossorigin='' />
	<script src='https://unpkg.com/leaflet@1.0.3/dist/leaflet.js' integrity='sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=='
		crossorigin=''></script>
	<link rel='stylesheet' href='https://unpkg.com/leaflet-draw@1.0.0/dist/leaflet.draw.css' />
	<script src='https://unpkg.com/leaflet-draw@1.0.0/dist/leaflet.draw.js'></script>
</head>
	<style>html, body {
		width: 100%;
		height: 100%;
		margin: 0;
		padding: 0;}
	</style>
	<style>#map{
		position: relative;
		width: 100.0%;
		height: 100.0%;
		left: 0.0%;
		top: 0.0%;
		}
	</style>
</head>
<body>
	<div id='map'></div>
	<script type='text/javascript'>
	// basic map definition and zoom control.
	var map = L.map('map');
	map.setView([39.8, -121.6], 10);
	L.control.scale().addTo(map);
	// drawing layer
	var drawnItems = L.featureGroup().addTo(map);
	// base map
	var base = L.tileLayer(
		'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',
		{maxZoom: 18, attribution:''}
	);
	// satelite
	var landsat = L.tileLayer(
		'https://{s}.tiles.mapbox.com/v4/mapbox.landsat-live/{z}/{x}/{y}.jpg?access_token=pk.eyJ1IjoiZWp0YWxib3QiLCJhIjoiY2ptMHBlOGdjMmZlaTNwb2dwMHE2Mm54NCJ9.xzceVNmAZy49SyFDb3UMaw',
		{ maxZoom: 18, attribution:'' }
	);
	// Topo
	var topo = L.tileLayer(
		'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
		{ maxZoom: 18, attribution:'' }
	);

	// Options to toggle between maps added to layers
	L.control.layers(
		{
			'base': base.addTo(map),
			'landsat': landsat.addTo(map),
			'topo': topo.addTo(map)
		},
		{
			'drawlayer': drawnItems,
		},
		{position: 'topleft', collapsed: false}
	).addTo(map);
	//Boilerplate to add the layer control.
	map.addControl(new L.Control.Draw({
		edit: {
			featureGroup: drawnItems,
			poly: {
				allowIntersection: false
			}
		},
		draw: {
			polygon: {
				allowIntersection: false,
				showArea: true
			}
		}
	}));
	// Helper function for saving veg score.
	function saveVeg() {
		var newVegScore = document.getElementById('veg_score').value
		var shape_id = document.getElementById('popup_leaflet_id').value
		map._layers[shape_id].feature.properties.vegScore = newVegScore
	}
	// Helper function to update veg scores.
	map.on(L.Draw.Event.CREATED, function(event) {
		var layer = event.layer;
		// add veg score.
		feature = layer.feature = layer.feature || {}; // Initialize feature
		feature.type = feature.type || "Feature"; // Initialize feature.type
		var props = feature.properties = feature.properties || {}; // Initialize feature.properties
		props.vegScore = '10';
		// add click handler that makes popup on each click.
		layer.on('click', function (e) {
			vegScore = e.target.feature.properties.vegScore
			layer.bindPopup("<input id='popup_leaflet_id' style='display:none' value=" + e.target._leaflet_id + ">Veg Score: <input type='text' id='veg_score' value=" + vegScore + "><button onclick='saveVeg()' type='button'>Save</button>")
			layer.openPopup()
		})
		drawnItems.addLayer(layer);
	});
	// gets and stringifies GeoJSON representation of the draw layer
	function button_click() {
		drawn_geojson = drawnItems.toGeoJSON()
		alert('We drew: ' + JSON.stringify(drawn_geojson))
	}
	// send an XML Http request to the server for data from getSubGridData() of weather.py
	function fireButton_click() {
		drawnItems = drawnItems.toGeoJSON()
		var eachShape = [];
		// A call to subGrid for each drawn shape
		for (i = 0; i < drawnItems.features.length; i++) {
			xhttp = new XMLHttpRequest();
			centerLon = (drawnItems.features[i].geometry.coordinates[0][0][0] + drawnItems.features[i].geometry.coordinates[0][2][0]) / 2
			centerLat = (drawnItems.features[i].geometry.coordinates[0][0][1] + drawnItems.features[i].geometry.coordinates[0][1][1]) / 2
			distLat = drawnItems.features[i].geometry.coordinates[0][1][1] - centerLat
			distLon = drawnItems.features[i].geometry.coordinates[0][0][0] - centerLon
			// xhttp.open("GET", "http://127.0.0.1:5000/firedata/39.810278/-121.437222/10/10/10", true); <-- centerpoint of map test (Camp Fire)
			xhttp.open("GET", "http://127.0.0.1:5000/firedata/" + centerLat + "/" + centerLon + "/" + distLat + "/" + distLon + "/10", true); 
			xhttp.send();
			setTimeout(function(){
				var xhttpData = JSON.parse(xhttp.responseText).dwml.data;
				// Logs each risk reading for each point of the subgrid into an array 
				var eachRisk = [];
				var sum = 0;
				var average = 0;
				for (j = 0; j < xhttpData.location.length; j++) {
					if (xhttpData.parameters[j]["fire-weather"].value[0] = "No Areas") {
						eachRisk.push(0);
					}
					else if (xhttpData.parameters[j]["fire-weather"].value[0] = "Elevated") {
						eachRisk.push(5);
						sum += 5;
					}
					else {
						eachRisk.push(10);
						sum += 10;
					}
					// drawnItems.features[i].properties.risk = eachRisk[j]; 
				}
				// logs the average of each array's quantitative risk readings into an array
				average = sum / eachRisk.length;
				eachShape.push(average);
			}, 8000);
		}
		// the function will skip to the alert and console without an additional time delay
		setTimeout(function(){
			// alert('Fire Risk is ' + eachShape);
			console.log(eachShape);
			return eachShape;
		}, 10000);
	}
</script>
<button type="button" onclick="button_click()" style="position:fixed; top:0; right: 0; z-index:999">Get GeoJson</button>
<button type="button" onclick="fireButton_click()" style="position:absolute; top: 20px; right: 0; z-index:999">Get Fire Risk</button>
</body>
</html>