<head>
	<title>Open Modeling Framework</title>
	<meta charset="utf-8">
	<link href="{{pathPrefix}}/static/omf.css" type="text/css" rel="stylesheet"/>
	<link rel="shortcut icon" href="{{pathPrefix}}/static/favicon.ico">
	<style>
	/*Styles here*/
	</style>
	{% if modelStatus == "running" %}<meta http-equiv="refresh" content="5"/>{% endif %}
	<!-- Library Imports -->
	<script type="text/javascript" src="{{pathPrefix}}/static/omf.js"></script>
	<script type="text/javascript" src="{{pathPrefix}}/static/jquery-1.9.1.js"></script>
	<script src="{{pathPrefix}}/static/highcharts4.src.js"></script>
	<!-- Data  Imports -->
	<script>allInputData={% if allInputData %}{{allInputData | safe}}{% else %}null{% endif %}</script>
	<script>allOutputData={% if allOutputData %}{{allOutputData | safe}}{% else %}null{% endif %}</script>
	<script>modelStatus="{{modelStatus}}"</script>
	<script>currentUser="{{datastoreNames.get('currentUser','test')}}"</script>
	<script type="text/javascript">
		function editFeeder(modelName, feederNum) {
			console.log("modelName:",modelName)
			studyUser = allInputData.user
			window.open("/feeder/" + studyUser + "/" + modelName + "/" + feederNum,  "_blank")
		}
	</script>
</head>
<body onload="init()">
	<div id="header">
		<div id="headInnerBlock">
			<div id="menuLeft">
				<a style="color:white" href="/">Open Modeling Framework</a> &#187;&nbsp;&nbsp;Model
				&#8220;<p id="titleText" style="display:inline"></p>&#8221;
			</div>
		</div>
	</div>
	<p class="reportTitle">Model Input</p>
	<div id="input" class="content">
		<form name="inputForm" action="/runModel/" onsubmit="event.preventDefault(); return isFormValid();" method="post">
			<div class="shortInput">
				<label>Model Type <a href="https://github.com/dpinney/omf/wiki/Models-~-voltageDrop" target="blank">Help?</a></label>
				<input type="text" id="modelType" name="modelType" value="{{modelName}}" readonly/>
			</div>
			<div class="shortInput">
				<label>Model Name</label>
				<input type="text" id="modelName" name="modelName" pattern="^[\w\s\d\.-]+$" required="required">
			</div>
			<div class="shortInput runningInline postRunInline">
				<label>User</label>
				<input type="text" id="user" name="user" readonly/>
			</div>
			<div class="runningInline postRunInline shortInput">
				<label>Created</label>
				<input type="text" id="created" name="created" readonly/>
			</div>
			<div class="postRunInline shortInput">
				<label>Run Time</label>
				<input type="text" id="runTime" name="runTime" readonly/>
			</div>
			<!-- <div class="shortInput">
				<label>Feeder</label>
				<button id="feederButton" type="button" onclick="javascript:editFeeder(allInputData.modelName,1);" style="display:block;width:125px;">Open Editor</button>
				<input type="text" id="feederName1" name="feederName1" style="display:none">
			</div> -->
			<div class="shortInput">
				<label>Start Time</label>
				<input type="text" id="startTime" name="startTime" pattern="^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$" required="required"
				oninvalid="setCustomValidity('Enter Date in format YYYY-MM-DD HH:MM:SS')" oninput="setCustomValidity('')">
			</div>
			<div class="shortInput">
				<label>End Time</label>
				<input type="text" id="endTime" name="endTime" pattern="^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$" required="required" oninvalid="setCustomValidity('Enter Date in format YYYY-MM-DD HH:MM:SS')"  oninput="setCustomValidity('')">
			</div>
			<div class="shortInput">
				<label>Number of Feeders</label>
				<input type="text" id="numoffeeders" name="numoffeeders" pattern="^[\w\s\d\.-]+$" required="required">
			</div>
			<div class="wideInput" style="text-align:right">
				<script>
				function openInNewTab(url) {
					var win = window.open(url, '_blank');
					win.focus();
				}
				</script>
				<button id="feederInfoURL" type="button" onclick="openInNewTab('http://gridlab-d.shoutwiki.com/wiki/Feeder_Taxonomy');">Feeder Info</button>
				<button id="deleteButton" type="button" class="stoppedInline postRunInline" onclick="deleteModel()">Delete</button>
				<button id="publishButton" type="button" class="postRunInline" onclick="publishModel()">Publish</button>
				<button id="duplicateButton" type="button" class="postRunInline" onclick="duplicateModel()">Duplicate</button>
				<button id="cancelButton" class="runningInline" type="button" onclick="cancelModel()">Cancel Run</button>
				<button id="runButton" class="stoppedInline postRunInline" onclick="showChoices()" type="submit">Run Model</button>
			</div>
			<body>
				<h1>Multiple Selections</h1>
				<fieldset>
				<label>
				   Select the feeders to be used.
				   (ctrl-click to select multiple lines)
				</label>
				<select id = "selFeeders"
				    multiple = "multiple"
				    size = "9">
				   <option value = "R1-12.47-1.glm">R1-12.47-1.glm</option>
				   <option value = "R1-12.47-2.glm">R1-12.47-2.glm</option>
				   <option value = "R1-12.47-3.glm">R1-12.47-3.glm</option>
				   <option value = "R2-12.47-1.glm">R2-12.47-1.glm</option>
				   <option value = "R2-12.47-2.glm">R2-12.47-2.glm</option>
				   <option value = "R2-12.47-3.glm">R2-12.47-3.glm</option>
				   <option value = "R3-12.47-1.glm">R3-12.47-1.glm</option>
				   <option value = "R3-12.47-2.glm">R3-12.47-2.glm</option>
				   <option value = "R3-12.47-3.glm">R3-12.47-3.glm</option>
				  </select>
				  </fieldset>
				<div id = "output">
				</div>
		</body>		
		<script type = "text/javascript">
			//from multi-select.html
			function showChoices(){
			  //retrieve data
			var selFeeder = document.getElementById("selFeeders");
			  //set up output string
			var result = [];
			  //step through options
			for (i = 0; i < selFeeder.length; i++){
			   //examine current option
				currentOption = selFeeder[i];
			   //print it if it has been selected
				if (currentOption.selected == true){
				result.push(currentOption.value);
				} // end if
			} // end for loop
			  //finish off the list and print it out
			  console.log(result)
			} // end showChoices
		</script>
	</form>
	</div>
	
		
	</form>
	<div id ="runIndicator" class="content running">
		Model running on server. Refresh the page to check for results, or wait for automatic refresh every 5 seconds.
	</div>
	<div id ="stopIndicator" class="content stopped" style="visibility: hidden">
		<pre id='errorText' style='overflow-x:scroll'></pre>
		<script type="text/javascript">
		if (typeof(allInputData.stderr) !== 'undefined') {
			gebi('stopIndicator').style.visibility = 'visible'
			gebi('errorText').innerHTML = 'MODEL ENCOUNTERED AN ERROR AS FOLLOWS: \n\n' + allInputData.stderr}
		</script>
	</div>
	<div id="output">
		<p class="reportTitle postRun" style="page-break-before:always">Timeseries Powerflow Results</p>
		<div id="voltageDropDiagram" class="tightContent postRun">
			<div id="chartContainer">
		</div>
		<script type="text/javascript">
			
			var seriesoptions=[]
			function dateOb(inStr) {return Date.parse(inStr.replace(/-/g,"/"))}
			for (var index in Object.keys(allOutputData)){
				var key = Object.keys(allOutputData)[index]
				startDate = dateOb(allOutputData[key].dates[0])
				dateInterval = dateOb(allOutputData[key].dates[1])-startDate
				seriesoptions.push(
					{ "marker":{"enabled":false},
					"dataLabels":{"enabled":false},
					"color":"red",
					"data":allOutputData[key].measured_real_power,
					"name":key, 
					"pointStart":startDate,
					"pointInterval":dateInterval},
					{ "marker":{"enabled":false},
					"dataLabels":{"enabled":false},
					"color":"orange",
					"data":allOutputData[key].measured_reactive_power,
					"name":key, 
					"pointStart":startDate,
					"pointInterval":dateInterval},
				)
			}
			h_c_options = {
				"credits": {"enabled":false},
				"plotOptions": {
					"series": {"shadow":false,"animation": false},
					"line": {"marker":{"enabled":false}},
					"dataLabels": {"enabled":true}
				},
				"xAxis": {
					"type": 'datetime',
					"dateTimeLabelFormats":{
						"time": '%e of %b'
					},
					"tickColor":"gray",
					"lineColor":"gray"},
				"title": {"text":null},
				"series": seriesoptions,
				"tooltip": false,
				"yAxis": {
					"title": {
						"text":"Power (W-AC)",
						"style":{"color":"gray"}
					},
					"min":0},
				"chart": {
					"zoomType":"x",
					"marginBottom":25,
					/*"marginTop":200,*/
					"width":1000,
					"height":700,
					"marginRight":20,
					"renderTo":"chartContainer",
					"type":"line"
				},
				"legend": {
					"enabled": true,
					"align": "center",
					"verticalAlign": "top",

				}
			}
			new Highcharts.Chart(h_c_options)
		</script>
	</div>
</body>