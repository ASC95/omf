<head>
	<title>Open Modeling Framework</title>
	<meta charset="utf-8">
	<link href="{{pathPrefix}}/static/omf.css" type="text/css" rel="stylesheet"/>
	<link rel="shortcut icon" href="{{pathPrefix}}/static/favicon.ico">
	<style>
	/*Styles go here.*/
		table{width:50%; font-size:16; padding:5px; border:1px;}
		td {padding:2px;}
	</style>
	{% if modelStatus == "running" %}<meta http-equiv="refresh" content="5"/>{% endif %}
	<!-- Library Imports -->
	<script type="text/javascript" src="{{pathPrefix}}/static/omf.js"></script>
	<script type="text/javascript" src="{{pathPrefix}}/static/jquery-1.9.1.js"></script>
	<script src="{{pathPrefix}}/static/highcharts4.src.js"></script>
	<!-- Data  Imports -->
	<script>allInputData={% if allInputData %}{{allInputData | safe}}{% else %}null{% endif %}</script>
	<script>allOutputData={% if allOutputData %}{{allOutputData | safe}}{% else %}null{% endif %}</script>
	<script>modelStatus="{{modelStatus}}"</script>
	<script>currentUser="{{datastoreNames.get('currentUser','test')}}"</script>
	<script type="text/javascript">
		var outputIDs = [];
		for (outputID in allOutputData.tableData){
			outputIDs.push(String(outputID));
		}
	</script>
	<!-- Global Functions -->
	<script type="text/javascript">
		function editNetwork(modelName, networkNum) {
			console.log("modelName:",modelName)
			studyUser = allInputData.user
			window.open("/network/" + studyUser + "/" + modelName + "/" + networkNum,  "_blank")
		}
		function insertMetric(tableId, vector) {
			// Add a vector to a table as a row.
			table = gebi(tableId)
			newRow = table.insertRow()
			if (vector.length > 0){
				newRow.insertCell().innerHTML = vector[0]
				cell = newRow.insertCell()
				if (isNaN()){
					cell.innerHTML = vector[1]
				}else{
					cell.innerHTML = delimitNumbers(vector[1].toFixed(2))
				}
			}
		}
		function showOutput(){
			// Show specific image/table and hide others.
			var sel = document.getElementById('outputSel').value;
			gebi(sel).style.display = 'inline';
			for (var i=0; i < outputIDs.length; i++){
				console.log(outputIDs[i], sel)
				if (outputIDs[i] != sel) {
					gebi(outputIDs[i]).style.display = 'none';
				}
			}
			document.getElementById("windowLoc").scrollIntoView()
		}
	</script>
</head>
<body onload="init()">
	<div id="header">
		<div id="headInnerBlock">
			<div id="menuLeft">
				<a style="color:white" href="/">Open Modeling Framework</a> &#187;&nbsp;&nbsp;Model
				&#8220;<p id="titleText" style="display:inline"></p>&#8221;
			</div>
		</div>
	</div>
	<p class="reportTitle">Model Input</p>
	<div id="input" class="content">
		<form name="inputForm" action="/runModel/" onsubmit="event.preventDefault(); return isFormValid();" method="post">
			<!-- Required Inputs -->
			<div class="shortInput">
				<label>Model Type <a href="https://github.com/dpinney/omf/wiki/Models-~-transmission" target="blank">Help?</a></label>
				<input type="text" id="modelType" name="modelType" value="_transmission" readonly/>
			</div>
			<div class="shortInput">
				<label>Model Name</label>
				<input type="text" id="modelName" name="modelName" pattern="^[\w\s\d\.-]+$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Network<span class="classic">A link to the transmission editor, which offers features such as interactive component editing, search, creation, MATPOWER (.mat) file import, and more.</span></label>
				<button id="networkButton" type="button" onclick="javascript:editNetwork(allInputData.modelName,1);" style="display:block;width:125px;">Open Editor</button>
				<input type="text" id="networkName1" name="networkName1" value="network1" pattern="^[\w\s\d\.-]+$" required="required" style="width:50%;">

			</div>
			<div class="shortInput runningInline postRunInline">
				<label>User</label>
				<input type="text" id="user" name="user" readonly/>
			</div>
			<div class="shortInput runningInline postRunInline ">
				<label>Created</label>
				<input type="text" id="created" name="created" readonly/>
			</div>
			<div class="shortInput postRunInline">
				<label>Run Time</label>
				<input type="text" id="runTime" name="runTime" readonly/>
			</div>
			<!-- Model Specific Inputs -->
			<div class="wideInput">
				<p class="inputSectionHeader">Simulation Specs</p>
			</div>
			<hr>
			<div class="shortInput">
				<label class="tooltip">Algorithm<span class="classic">The MATPOWER powerflow solver method. Can be set to NR (Newton Raphson), FDXB (Fast-Decoupled XB Version), FDBX (Fast-Decoupled BX Version) or GS (Gauss Seidel). These are the solution algorithms supported by MATPOWER.</span></label>
				<select id="algorithm" name="algorithm">
					<option value="NR" selected="selected">NR</option>
					<option value="FDXB">FDXB</option>
					<option value="FDBX">FDBX</option>
					<option value="GS">GS</option>
				</select>
			</div>
			<div class="shortInput">
				<label class="tooltip">Model<span class="classic">The powerflow formulation, set to AC or DC.</span></label>
				<select id="model" name="model">
					<option value="AC">AC</option>
					<option value="DC">DC</option>
				</select>
			</div>
			<div class="shortInput">
				<label class="tooltip">Tolerance<span class="classic">The termination tolerance for powerflow, in units P and Q dispatch per unit.</span></label>
				<input type="text" id="tolerance" name="tolerance" value="0.00000001" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Iteration<span class="classic">The maximum number of iterations for the NR, FDXB, FDBX or GS solver method.</span></label>
				<input type="text" id="iteration" name="iteration" value="1000" required="required" pattern="^(\d{2,}|[1-9])(\.\d+)?$">
			</div>
			<div class="shortInput">
				<label class="tooltip">Generation Limit<span class="classic">Whether or not to set power limits on the generators in the system. 0 denotes "do not enforce", 1 denotes "enforce with simultaneous bus type conversion" and 2 denotes "enforce with one-at-a-time bus type conversion".</span></label>
				<select id="model" name="model">
					<option value="0" selected="selected">0</option>
					<option value="1">1</option>
					<option value="2">2</option>
				</select>
			</div>
			<!-- Required Buttons -->
			<div class="wideInput" style="text-align:right">
				<button id="deleteButton" type="button" class="stoppedInline postRunInline" onclick="deleteModel()">Delete</button>
				<button id="publishButton" type="button" class="postRunInline" onclick="publishModel()">Publish</button>
				<button id="duplicateButton" type="button" class="postRunInline" onclick="duplicateModel()">Duplicate</button>
				<button id="cancelButton" class="runningInline" type="button" onclick="cancelModel()">Cancel Run</button>
				<button id="runButton" type="submit" class="stoppedInline postRunInline">Run Model</button>
			</div>
		</form>
	</div>
	<div id ="runIndicator" class="content running">
		Model running on server. Refresh the page to check for results, or wait for automatic refresh every 5 seconds.
	</div>
	<div id ="stopIndicator" class="content stopped" style="visibility: hidden">
		<pre id='errorText'></pre>
		<script type="text/javascript">
		if (typeof(allInputData.stderr) !== 'undefined') {
			gebi('stopIndicator').style.visibility = 'visible'
			gebi('errorText').innerHTML = 'MODEL ENCOUNTERED AN ERROR AS FOLLOWS: \n\n' + allInputData.stderr}
		</script>
	</div>
	<!-- Output tables, graphs, etc. -->
	<div id="output">
		<p class="reportTitle postRun">Transmission Output</p>
		<div id="anamoliesreport" class="tightContent postRun" style="max-height:1000px;margin-bottom:5px;">
			<!-- Network Voltage, Powerflow, etc. -->
			<div align="right">
				<select onchange="showOutput();" name="outputSel" id="outputSel" style="width:350px;font-size:14pt;">
					<script type="text/javascript">
						for (var i=0; i < outputIDs.length; i++){
							if (outputIDs[i] == 'volts'){var name = 'Voltage';}
							else if (outputIDs[i] == 'powerReal'){var name = 'Real Power';}
							else if (outputIDs[i] == 'powerReact'){var name = 'Reactive Power';}
							$('#outputSel').append("<option value='"+outputIDs[i]+"' style='font-size:10pt;'>"+name+"</option>")}
					</script>
				</select>
			</div>
			<div id="windowLoc"></div>
			<div id="volts">
				<center>
				<img id="voltageDropChart" style="width:600px;height:600px;" />
				<script type="text/javascript">gebi("voltageDropChart").src = "data:image/png;base64," + allOutputData.voltsChart</script>
				<!--
				<img id="img1" src="" style="width:600px;height:600px;">
				<script>gebi("img1").src = "/downloadModelData/"+allInputData.user+"/"+allInputData.modelName+"/volts.jpg"</script>
				-->
				<div style="max-height:300px;overflow-y:scroll;">
					<table id="voltsTable">
						<thead>
							<th>Component Name</th>
							<th>Voltage Per Unit</th>
						</thead>
					</table>
				</div>
				</center>
			</div>
			<div id="powerReal" style="display:none;">
				<center>
				<img id="powerRealDrop" style="width:600px;height:600px;" />
				<script type="text/javascript">gebi("powerRealDrop").src = "data:image/png;base64," + allOutputData.powerRealChart</script>
				<!--
				<img id="img2" src="" style="width:600px;height:600px;">
				<script>gebi("img2").src = "/downloadModelData/"+allInputData.user+"/"+allInputData.modelName+"/powerReal.jpg"</script>
				-->
				<div style="max-height:300px;overflow-y:scroll;">
					<table id="powerRealTable">
						<thead>
							<th>Component Name</th>
							<th>Real Power (MW)</th>
						</thead>
					</table>
				</div>
				</center>
			</div>
			<div id="powerReact" style="display:none;">
				<center>
				<img id="powerReactDrop" style="width:600px;height:600px;" />
				<script type="text/javascript">gebi("powerReactDrop").src = "data:image/png;base64," + allOutputData.powerReactChart</script>
				<!--
				<img id="img3" src="" style="width:600px;height:600px;">
				<script>gebi("img3").src = "/downloadModelData/"+allInputData.user+"/"+allInputData.modelName+"/powerReact.jpg"</script>
				-->
				<div style="max-height:300px;overflow-y:scroll;">
					<table id="powerReactTable">
						<thead>
							<th>Component Name</th>
							<th>Reactive Power (MVAR)</th>
						</thead>
					</table>
				</div>
				</center>
			</div>
			<script>
				var comp = 0;
				var val = 1;
				console.log("data", allOutputData)
				for (row = 0; row < allOutputData.tableData['volts'][0].length; row++)
				{
					insertMetric("voltsTable", [allOutputData.tableData["volts"][comp][row], allOutputData.tableData["volts"][val][row]])
				}
				for (row = 0; row < allOutputData.tableData['powerReal'][0].length; row++)
				{
					insertMetric("powerRealTable", [allOutputData.tableData["powerReal"][comp][row], allOutputData.tableData["powerReal"][val][row]])
				}
				for (row = 0; row < allOutputData.tableData['powerReact'][0].length; row++)
				{
					insertMetric("powerReactTable", [allOutputData.tableData["powerReact"][comp][row], allOutputData.tableData["powerReact"][val][row]])
				}
			</script>
		</div>
	</div>
</body>