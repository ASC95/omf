<head>
	<title>Open Modeling Framework</title>
	<meta charset="utf-8">
	<link href="{{pathPrefix}}/static/omf.css" type="text/css" rel="stylesheet"/>
	<link rel="shortcut icon" href="{{pathPrefix}}/static/favicon.ico">
	
	<style type="text/css">
	/*Styles here*/
				.wrapper{
					float: left;
					width: 50%;
					height: 90%;
					position: relative;
				}
				#feederDiagram{ 
					width: 100%;
					height: 75%;
				}
				#damageSummary{
					width: 100%;
					height: 25%;
				}
				#rdtSummary{
					width: 100%;
					height: 100%;
				}
				#powerflowCheck{
					position: absolute;
					z-index: 10;
					bottom: 0;
					right: 0;
					background-color: red;
				}
				/*article {
					position: relative;
					text-align: center;
					transform: translate(-50%, -50%);
				}*/
				table {
					border-collapse: collapse;
					width: 100%;
				}
				table, th, td {
					border: 1px solid grey;
					font-size: 0.8em;

				}
				td, th {
					text-align: left;
					padding: 10px;
				}
				th {
					background-color: #44474C;
					color: #BFC4CC;
				}
				
	</style>
	{% if modelStatus == "running" %}<meta http-equiv="refresh" content="5"/>{% endif %}
	<!-- Library Imports -->
	<script type="text/javascript" src="{{pathPrefix}}/static/omf.js"></script>
	<script type="text/javascript" src="{{pathPrefix}}/static/jquery-1.9.1.js"></script>
	<!-- Data  Imports -->
	<script>allInputData={% if allInputData %}{{allInputData | safe}}{% else %}null{% endif %}</script>
	<script>allOutputData={% if allOutputData %}{{allOutputData | safe}}{% else %}null{% endif %}</script>
	<script>modelStatus="{{modelStatus}}"</script>
	<script>currentUser="{{datastoreNames.get('currentUser','test')}}"</script>
	<script type="text/javascript">
		function editFeeder(modelName, feederNum) {
			console.log("modelName:",modelName)
			studyUser = allInputData.user
			window.open("/feeder/" + studyUser + "/" + modelName + "/" + feederNum,  "_blank")
		}
	</script>
</head>
<body onload="init()">
	<div id="header">
		<div id="headInnerBlock">
			<div id="menuLeft">
				<a style="color:white" href="/">Open Modeling Framework</a> &#187;&nbsp;&nbsp;Model
				&#8220;<p id="titleText" style="display:inline"></p>&#8221;
			</div>
		</div>
	</div>
	<p class="reportTitle">Model Input</p>
	<div id="input" class="content">
			<form name="inputForm" action="/runModel/" onsubmit="event.preventDefault(); return isFormValid();" method="post">
			<div class="shortInput">
				<label>Model Type <a href="https://github.com/dpinney/omf/wiki/Models-~-voltageDrop" target="blank">Help?</a></label>
				<input type="text" id="modelType" name="modelType" value="{{modelName}}" readonly/>
			</div>
			<div class="shortInput">
				<label>Model Name</label>
				<input type="text" id="modelName" name="modelName" pattern="^[\w\s\d\.-]+$">
			</div>
			<div class="shortInput runningInline postRunInline">
				<label>User</label>
				<input type="text" id="user" name="user" readonly/>
			</div>
		
			<div class="runningInline postRunInline shortInput">
				<label>Created</label>
				<input type="text" id="created" name="created" readonly/>
			</div>
			<div class="postRunInline shortInput">
				<label>Run Time</label>
				<input type="text" id="runTime" name="runTime" readonly/>
			</div>
			<div class="shortInput">
				<label>Feeder</label>
				<button id="feederButton" type="button" onclick="javascript:editFeeder(allInputData.modelName,1);" style="display:block;width:125px;">Open Editor</button>
			</div>
	
			
			<div class="wideInput">
				<p class="inputSectionHeader">Financial Specs</p>
			</div>
			<hr>

			<div class="shortInput">
				<label class="tooltip">Line Fixed Cost ($)</label>
				<input type="text" id="lineFixedCost" name="lineFixedCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">Line Unit Cost ($/ft)</label>
				<input type="text" id="lineUnitCost" name="lineUnitCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">Switch Cost ($)</label>
				<input type="text" id="switchCost" name="switchCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">Hardening Unit Cost ($/ft)</label>
				<input type="text" id="hardeningUnitCost" name="hardeningUnitCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">DG Fixed Cost ($)</label>
				<input type="text" id="dgFixedCost" name="dgFixedCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">DG Unit Cost ($/MW)</label>
				<input type="text" id="dgUnitCost" name="dgUnitCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">Hardening Fixed Cost ($)</label>
				<input type="text" id="hardeningFixedCost" name="hardeningFixedCost">
			</div>
			<div class="shortInput">
				<label class="tooltip">Max DG Per Generator (MW)</label>
				<input type="text" id="maxDG" name="maxDG">
			</div>
			<div class="shortInput">
				<label class="tooltip">Hardening Candidates</label>
				<input type="text" id="hardeningCandidates" name="hardeningCandidates">
			</div>
			<div class="shortInput">
				<label class="tooltip">New Line Candidates</label>
				<input type="text" id="newLineCandidates" name="newLineCandidates">
			</div>
			<div class="shortInput">
				<label class="tooltip">Generator Candidates</label>
				<input type="text" id="generatorCandidates" name="generatorCandidates">
			</div>

			<div class="wideInput">
				<p class="inputSectionHeader">Simulation Specs</p>
			</div>
			<hr>

			<div class="shortInput">
				<label class="tooltip">Critical Load Met (%)</label>
				<input type="text" id="criticalLoadMet" name="criticalLoadMet">
			</div>
			<div class="shortInput">
				<label class="tooltip">Non-Critical Load Met (%)</label>
				<input type="text" id="nonCriticalLoadMet" name="nonCriticalLoadMet">
			</div>
			<div class="shortInput">
				<label class="tooltip">Chance Constraint (%)</label>
				<input type="text" id="chanceConstraint" name="chanceConstraint">
			</div>
			<div class="shortInput">
				<label class="tooltip">Phase Variation</label>
				<input type="text" id="phaseVariation" name="phaseVariation">
			</div>
			<div class="shortInput">
				<label class="tooltip">Weather Impacts (.asc file)<span class="classic">Please see the documentation at the help link for the required format. If this field is blank the OMF will re-use the file from the previous run.</span></label>
				<script>var fileName=true;</script>
				<input type="file" id="weatherImpactsFile" name="weatherImpactsFile" accept=".asc" onchange="handle_files(this.files)">
				<input id="weatherImpacts" name="weatherImpacts" type="hidden">
				<!-- Format the file input and populate it with a saved file. -->
				<input type="hidden" id="fileName" name="fileName" readonly="readonly">
				<div id="fileBackground"></div>
				<div id="fileExists"><label for="weatherImpactsFile" id="weatherImpactsFileName" name="weatherImpactsFileName"></label></div>
				<script>
					if (typeof allInputData.weatherImpactsFileName !== 'undefined') {					
						document.getElementById('weatherImpactsFileName').innerHTML = allInputData.weatherImpactsFileName;
					}
					else {
						document.getElementById('weatherImpactsFileName').innerHTML = 'Please select a file'
						gebi('weatherImpactsFile').setAttribute('required', 'required')
					}
					// File handler function.
					function handle_files(files) {
						// read file to a hidden input field
						reader = new FileReader()
						reader.readAsText(files[0])
						reader.onload = loaded
						function loaded(evt) {
							evt.target.result
							gebi("weatherImpacts").value = reader.result
							var FileName = gebi("weatherImpactsFile").value.split("\\");
							var FileName = FileName[FileName.length-1];
							document.getElementById('weatherImpactsFileName').innerHTML = FileName;
							gebi("fileName").value = FileName;
						}
					}
				</script>
			</div>
			<div class="shortInput">
				<label class="tooltip">Pole Data (.json file)<span class="classic">Please see the documentation at the help link for the required format. If this field is blank the OMF will re-use the file from the previous run.</span></label>
				<script>var fileName=true;</script>
				<input type="file" id="poleDataFile" name="poleDataFile" accept=".asc" onchange="handle_pole_files(this.files)">
				<input id="poleData" name="poleData" type="hidden">
				<!-- Format the file input and populate it with a saved file. -->
				<input type="hidden" id="fileName" name="fileName" readonly="readonly">
				<div id="fileBackground"></div>
				<div id="fileExists"><label for="poleDataFile" id="poleDataFileName" name="poleDataFileName"></label></div>
				<script>
					if (typeof allInputData.poleDataFileName !== 'undefined') {					
						document.getElementById('poleDataFileName').innerHTML = allInputData.poleDataFileName;
					}
					else {
						document.getElementById('poleDataFileName').innerHTML = 'Please select a file'
						gebi('poleDataFile').setAttribute('required', 'required')
					}
					// File handler function.
					function handle_pole_files(files) {
						// read file to a hidden input field
						reader = new FileReader()
						reader.readAsText(files[0])
						reader.onload = loaded
						function loaded(evt) {
							evt.target.result
							gebi("poleData").value = reader.result
							var FileName = gebi("poleDataFile").value.split("\\");
							var FileName = FileName[FileName.length-1];
							document.getElementById('poleDataFileName').innerHTML = FileName;
							gebi("fileName").value = FileName;
						}
					}
				</script>
			</div>
			<div class="shortInput">
				<label>Simulation Date</label>
				<input type="text" id="simDate" name="simDate">
			</div>
			<div class="shortInput">
				<label class="tooltip">Zip Code<span class="classic">Zip code of the planned array's geographical location.</span></label>
				<input type="text" id="zipCode" name="zipCode">
			</div>

			<div class="wideInput" style="text-align:right">
				<button id="deleteButton" type="button" class="stoppedInline postRunInline" onclick="deleteModel()">Delete</button>
				<button id="publishButton" type="button" class="postRunInline" onclick="publishModel()">Publish</button>
				<button id="duplicateButton" type="button" class="postRunInline" onclick="duplicateModel()">Duplicate</button>
				<button id="cancelButton" class="runningInline" type="button" onclick="cancelModel()">Cancel Run</button>
				<button id="runButton" type="submit">Run Model</button>
			</div>
		</form>
	</div>
	<div id="output" class="postRun">
		<p class="reportTitle" style="page-break-before:always">Voltage Drop Diagram</p>

		<div class="content" style="overflow: auto">
				<div id="diagram" style="width: 40%; float: left;">	
					<h4 style="text-align: center;">One Line Diagram</h4>
					<img style="display: block; margin-left: auto; margin-right: auto; max-width: 100%; max-height: 100%;" src="{{pathPrefix}}/scratch/LPNORM Integration Code/Data/feederChart.png" alt="Feeder Diagram">
				</div>
				
				<div id="tables" style="width: 60%; float: right;">
					<h4 style="float: left">Resilience Solution</h4>
					<h4 style="float: right; color: #54c465;">Validated by GRIDLAB-D</h4>
					<br><br>
					<table>
						<tr>
							<th>Total Cost</th>
						</tr>
						<tr>
							<td>$125,000</td>
						</tr>
					</table>
					<br>
					<table>
						<tr>
							<th>Device ID</th>
							<th>Type</th>
							<th>Action</th>
							<th>Cost</th>
						</tr>
						<tr>
							<td>1</td>
							<td>Line</td>
							<td>Built, Switch Built</td>
							<td>$15,000</td>
						</tr>
						<tr>
							<td>2</td>
							<td>Line</td>
							<td>Hardened</td>
							<td>$2,000</td>
						</tr>
						<tr>
							<td>3</td>
							<td>Generator</td>
							<td>Built with 5 MW of capacity</td>
							<td>$50,000</td>
						</tr>
						<tr>
							<td>...</td>
							<td>...</td>
							<td>...</td>
							<td>...</td>
						</tr>
					</table>
				</div>
			</div>	


			<div class="content" style="overflow: auto">
				<div id="diagram" style="width: 40%; float: left;">	
					<h4 style="text-align: center;">Damage Scenario Result</h4>
					<h4 style="text-align: center;">Weather Type: Wind</h4>
					<img style="display: block; margin-left: auto; margin-right: auto; max-width: 100%; max-height: 100%;" src="{{pathPrefix}}/scratch/LPNORM Integration Code/Data/feederChart.png" alt="Feeder Diagram">
				</div>
				
				<div id="tables" style="width: 60%; float: right;">
					<div style="float: left">
						<h4 style="padding: 3px; float: left; border: 1px solid black; background-color: #AAD0FF">Load lost: 14%</h4>
						<h4 style="padding: 3px; float: right; border: 1px solid black; background-color: #AAD0FF">Critical load lost: 0%</h4>
					</div>
					<select style="width: 50%;float: right;">
							<option value="Scenario 1">Scenario 1</option>
							<option value="Scenario 2">Scenario 2</option>
							<option value="Scenario 3">Scenario 3</option>
					</select>
					<br>
					<br>
					<table>
						<tr>
							<th>Device ID</th>
							<th>Type</th>
							<th>Result</th>
						</tr>
						<tr>
							<td>1</td>
							<td>Line</td>
							<td>Disabled</td>
						</tr>
						<tr>
							<td>3</td>
							<td>Bus</td>
							<td>Load lost</td>
						</tr>
						<tr>
							<td>7</td>
							<td>Generator</td>
							<td>Power output [1000,0,0]</td>
						</tr>
						<tr>
							<td>...</td>
							<td>...</td>
							<td>...</td>
						</tr>
						<tr>
							<td>...</td>
							<td>...</td>
							<td>...</td>
						</tr>
					</table>
				</div>
			</div>
			<div class="content" style="overflow: auto">
				<p>GFM Output:</p>
				<iframe style="width:95%;height:94%;" src="{{pathPrefix}}/scratch/uploads/data.json"></iframe>
			</div>
			<div class="content" style="overflow: auto">
				<p>RDT Output:</p>
				<iframe style="width:95%;height:94%;" src="{{pathPrefix}}/scratch/LPNORM Integration Code/Data/rdtOutputSimple_Market_System.json"></iframe>
			</div>
	</div>
</body>