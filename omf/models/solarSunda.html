<head>
	<title>Open Modeling Framework</title>
	<meta charset="utf-8">
	<link href="{{pathPrefix}}/static/omf.css" type="text/css" rel="stylesheet"/>
	<link rel="shortcut icon" href="{{pathPrefix}}/static/favicon.ico">
	<link href="{{pathPrefix}}/static/models.css" type="text/css" rel="stylesheet"/>
	{% if modelStatus == "running" %}<meta http-equiv="refresh" content="5"/>{% endif %}
	<!-- Library Imports -->
	<script type="text/javascript" src="{{pathPrefix}}/static/omf.js"></script>
	<script type="text/javascript" src="{{pathPrefix}}/static/jquery-1.9.1.js"></script>
	<script src="{{pathPrefix}}/static/highcharts4.src.js"></script>
	<script src="{{pathPrefix}}/static/d3.v3.js"></script>
	<!-- Global Funcs Import -->
	<script type="text/javascript" src="{{pathPrefix}}/static/models.js"></script>
	<!-- Data  Imports -->
	<script>allInputData={% if allInputData %}{{allInputData | safe}}{% else %}null{% endif %}</script>
	<script>allOutputData={% if allOutputData %}{{allOutputData | safe}}{% else %}null{% endif %}</script>
	<script>modelStatus="{{modelStatus}}"</script>
	<script>currentUser="{{datastoreNames.get('currentUser','test')}}"</script>
</head>
<body onload="init()">
	<div id="title">
		<div id="logoBox"><a href="/">&#10059;</a></div>
		<p id="titleText">New Solar SUNDA Financial Model</p>
	</div>
	<p class="reportTitle">Model Description</p>
	<div id="input" class="content">
		<form name="inputForm" {% if quickRender %}action="/quickRun/"{% else %}action="/runModel/"{% endif %} method="post">
			<div class="shortInput">
				<label>Model Type <a href="https://github.com/dpinney/omf/wiki/Models:-solarSunda">Help?</a> </label>
				<input type="text" id="modelType" name="modelType" value="solarSunda" readonly/>
			</div>
			{% if quickRender %}
			<div class="shortInput">
				<label>Email Address</label>
				<input type="email" id="quickRunEmail" name="quickRunEmail" required="required">
			</div>
			{% else %}
			<div class="shortInput">
				<label>Model Name</label>
				<input type="text" id="modelName" name="modelName" pattern="^[\w\s\d\.-]+$" required="required">
			</div>
			{% endif %}
			{% if not quickRender %}
			<div class="shortInput runningInline postRunInline">
				<label>User</label>
				<input type="text" id="user" name="user" readonly/>
			</div>
			{% endif %}
			<div class="shortInput runningInline postRunInline">
				<label>Created</label>
				<input type="text" id="created" name="created" readonly/>
			</div>
			<div class="shortInput postRunInline">
				<label>Run Time</label>
				<input type="text" id="runTime" name="runTime" readonly/>
			</div>
			<div class="wideInput">
				<p class="inputSectionHeader">System and Co-Op Information</p>
			</div>
			<hr>
			<div class="shortInput">
				<label class="tooltip">Zip Code<span class="classic">Zip code of the systems geographical location.</span></label>
				<input type="text" id="zipCode" name="zipCode" value="90210" pattern="^\d{5}(?:[-\s]\d{4})?$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Land<span class="classic">Whether the land is owned, purchased or leased.</span></label>
				<select id="landOwnership" name="landOwnership">
					<option value="Owned">Owned</option>
					<option value="Purchased">Purchased</option>
					<option value="Leased">Leased</option>
				</select>
			</div>
			<div class="shortInput">
				<label class="tooltip">Cost ($/acre)<span class="classic">Cost of land per acre.</span></label>
				<input type="text" id="costAcre" name="costAcre" value="10000" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">System Size (kW-AC)<span class="classic">Size of the inverter in kW-AC for the system.</span></label>
				<input type="text" id="systemSize" name="systemSize" value="1000" required="required" pattern="^\d+\.?\d*?$">
			</div>
			<div class="shortInput">
				<label class="tooltip">Module Cost ($/Wp)<span class="classic">Cost per watt.</span></label>
				<input type="text" id="moduleCost" name="moduleCost" value="0.70" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Racking Cost ($/Wp)<span class="classic">Cost per watt.</span></label>
				<input type="text" id="rackCost" name="rackCost" value="0.137" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Inverter Unit Cost ($)<span class="classic">Cost for inverters: will be set to $61,963 if the array size is less than 250kW-AC, and $107,000 if greater than 250kW-AC.</span></label>
				<input type="text" id="inverterCost" name="inverterCost" value="61963" pattern="^\d+\.?\d*$" required="required" readonly="true">
				<script type="text/javascript">$("#inverterCost").attr("value", allInputData.inverterCost)</script>
			</div>
			<div class="shortInput">
				<label class="tooltip">Mechanical Labor ($/hr)<span class="classic">Hourly labor cost.</span></label>
				<input type="text" id="mechLabor" name="mechLabor" value="35" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Electrical Labor ($/hr)<span class="classic">Hourly labor cost.</span></label>
				<input type="text" id="elecLabor" name="elecLabor" value="50" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Project Management Cost ($)<span class="classic">Covers the cost for co-op time and expense in doing the project.</span></label>
				<input type="text" id="pmCost" name="pmCost" value="15000" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Interconnect Costs ($)<span class="classic">Costs for connecting from the medium voltage transformer to the substation.</span></label>
				<input type="text" id="interCost" name="interCost" value="25000" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">Development Costs (%)<span class="classic">The legal costs associated with setting up such a system, if doing a Tax Equity flip this may be as much as 5%.</span></label>
				<input type="text" id="devCost" name="devCost" value="2" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required">
			</div>
			<div class="shortInput">
				<label class="tooltip">EPC Markup (%)<span class="classic">Costs as a percent of hardware costs. Usually 10% of Hardware Costs, but since they can allow the co-op to purchase PV modules, inverters and racking from National Discount program and only charge the 10% on the balance of the system hardware needed to complete, this can also be 3% in that case.</span></label>
				<input type="text" id="EPCRate" name="EPCRate" pattern="^(100|\d\d|\d)(\.\d+)?$" value="3" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">Distribution Adder ($/kWH)<span class="classic">Provides comparison for existing PV rate to existing retail rate. </span></label>
				<input type="text" id="distAdder" name="distAdder" value="0" pattern="^\d+\.?\d*$" required="required">
			</div>
			<div class="wideInput">
				<p class="inputSectionHeader">Financing Information</p>
			</div>
			<hr>
			<div class="shortInput">
				<label class="tooltip">Discount Rate (%)<span class="classic">The cost of capital to the co-op, close to the 20yr Treasury-bill rate for the project period.</span></label>
				<input type="text" id="discRate" name="discRate" value="2.32" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">Loan Interest Rate (%)<span class="classic">Loan interest rate, usually from 2.0% for RUS to 8.5% for a commercial lender.</span></label>
				<input type="text" id="loanRate" name="loanRate" value="2.00" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">NCREB Tax Credit Rate (%)<span class="classic">The rate used by the Treasury Department to calculate the 70% interest reimbursement.</span></label>
				<input type="text" id="NCREBRate" name="NCREBRate" value="4.06" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">Tax Lease Rate (%)<span class="classic">Tax lease rate, usually utilized by the for-profit subsidiary owned by the co-op.</span></label>
				<input type="text" id="taxLeaseRate" name="taxLeaseRate" value="8.45" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">Targeted Tax Equity Return (%)<span class="classic">Tax equity return rate, typical Tax equity partners in the renewable market are looking for about 8.5%</span></label>
				<input type="text" id="taxEquityReturn" name="taxEquityReturn" value="8.50" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="wideInput">
				<p class="inputSectionHeader">PPA Information</p>
			</div>
			<hr>
			<div class="shortInput">
				<label class="tooltip">First year energy cost ($/MWh)<span class="classic">Used to compare Utility-owned facilities to 3rd party PPA offerings.  Set to 0 if unneeded.</span></label>
				<input type="text" id="firstYearEnergyCostPPA" name="firstYearEnergyCostPPA" value="57.5" pattern="^\d+\.?\d*?$" required="required"/>
			</div>
			<div class="shortInput">
				<label class="tooltip">Annual Escalation Rate (%)<span class="classic">A fixed escalation rate at which the price will increase year to year.</span></label>
				<input type="text" id="annualEscRatePPA" name="annualEscRatePPA" value="3.00" pattern="^(100|\d\d|\d)(\.\d+)?$" required="required"/>
			</div>
			<div class="wideInput" style="text-align:right">
				{% if not quickRender %}
				<button id="deleteButton" type="button" class="stoppedInline postRunInline" onclick="deleteModel()">Delete</button>
				<button id="publishButton" type="button" class="postRunInline" onclick="publishModel()">Publish</button>
				<button id="duplicateButton" type="button" class="postRunInline" onclick="duplicateModel()">Duplicate</button>
				{% endif %}
				<button id="runButton" type="submit" class="preRun">Run Model</button>
				<button id="rerunButton" type="submit" class="stoppedInline postRunInline">Re-Run Model</button>
			</div>
		</form>
	</div>
	<div id ="runIndicator" class="content running">
		Model running on server. Refresh the page to check for results, or wait for automatic refresh every 5 seconds.
	</div>
	<div id ="stopIndicator" class="content stopped">
		<p>Model cancelled or encountered an error. Please change inputs and re-run.</p>
		<pre id='errorText'></pre>
		<script type="text/javascript">if (typeof(allInputData.stderr) !== 'undefined') {gebi('errorText').innerHTML = '\nFULL ERROR TEXT FOLLOWS\n' + allInputData.stderr}</script>
	</div>
	<div id="output">
		<script id="globalOutputScripting">
			Highcharts.setOptions({global: { useUTC: false }, credits:{enabled:false} })
		</script>
		<p class="reportTitle postRun">Cost Summary</p>
		<div id="chartsReport" class="tightContent postRun">
			<div id="comparisonPieChart" style="display:inline-block"></div>
			<script>
				costChart = new Highcharts.Chart({
					title: {text: 'System Cost Breakdown'},
					series: [{type: "pie", name:"% of Total Cost", data:allOutputData.costsPieChart}],
					tooltip: {pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'},
					chart:{"marginBottom":40,"zoomType":"disabled","renderTo":"comparisonPieChart","type":"column","marginRight":20,"marginBottom":70,"height":400,"width":490,"backgroundColor":null},
					plotOptions: {
						pie: {dataLabels: {enabled:false, style:{color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'}, connectorColor: 'silver'}, showInLegend:true}}})
			</script>
			<div id="monthlyPerformanceDiv" style="display:inline-block"></div>
			<script>
				levelizedChart = new Highcharts.Chart({
					plotOptions:{column:{dataLabels:{enabled:true}, pointPadding:0.2, borderWidth:0}},
					xAxis:{type:'category',tickColor:'gray',lineColor:'gray',crosshair:true},
					yAxis:{title:{text:'Levelized Cost ($/MWh)'}},
					title:{text:'Levelized Cost Comparison'},
					series:[{name:'Levelized Cost ($/MWh)',color:'green', data:allOutputData.LevelizedCosts}],
					chart:{marginBottom:40,zoomType:'disabled',renderTo:'monthlyPerformanceDiv',type:'column', marginRight:20, marginBottom:70, height:400, width:490,backgroundColor:null},
					tooltip:false,
					legend:false})
			</script>
		</div>
		<p class="reportTitle postRun">Financial Summary</p>
		<div id="finSummaryReport" class="content postRun" style="margin-top:5px">
			<div class="shortInput">
				<strong>Installed System Cost</strong>
				<p id="totalCost"></p>
				<script>gebi("totalCost").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.totalCost).toFixed(0))</script>
			</div>
			<div class="shortInput">
				<strong>$/Wp-DC Installed</strong>
				<p id="costWdc"></p>
				<script>gebi("costWdc").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.costWdc).toFixed(2))</script>
			</div>
			<div class="shortInput">
				<strong class="tooltip" style="display:inline">Calculated Capacity Factor<span class="classic">Calculated as first year generation (kWh-AC) divided by inverters size (kW-AC).</span></strong>
				<p id="capFactor"></p>
				<script>gebi("capFactor").innerHTML = delimitNumbers(parseFloat(allOutputData.capFactor).toFixed(0)) +  "%"</script>
			</div>
			<div class="shortInput">
				<strong>First Year System Output (MWh-AC)</strong>
				<p id="1yearMWH"></p>
				<script>gebi("1yearMWH").innerHTML = delimitNumbers((parseFloat(allOutputData.oneYearGenerationWh)/1000000).toFixed(0))</script>
			</div>
			<div class="shortInput">
				<strong>Climate Data Selected</strong>
				<p id="climSource"></p>
				<script>gebi("climSource").innerHTML = allInputData.climateName</script>
			</div>
			<div class="shortInput">
				<strong>PPA First Year Cost ($/MWh)</strong>
				<p id="firstYearCostKWhPPA"></p>
				<script>gebi("firstYearCostKWhPPA").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.firstYearCostKWhPPA).toFixed(2))</script>
			</div>
			<div class="shortInput">
				<strong>PPA Yearly Escalation</strong>
				<p id="yearlyEscalationPPA"></p>
				<script>gebi("yearlyEscalationPPA").innerHTML = delimitNumbers(parseFloat(allOutputData.yearlyEscalationPPA).toFixed(0)) + "%"</script>
			</div>
			<hr>
			<table>
				<style>td, th {padding:5 0 5 20;}</style>
				<thead>
					<th style="width:350px"></th>
					<th style="width:100px">Direct Loan</th>
					<th style="width:100px">NCREBs Financing</th>
					<th style="width:100px">Tax Lease Structure</th>
					<th style="width:100px">Tax Equity Flip Structure</th>
					<th style="width:100px">PPA Comparison</th>
				</thead>
				<tr>
					<th>Levelized Cost of Energy ($/MWh)</th>
					<td id="levelCostDirect">$79.34</td>
					<td id="levelCostNCREB">$79.34</td>
					<td id="levelCostTaxLease">$79.34</td>
					<td id="levelCostTaxEquity">$79.34</td>
					<td id="levelCostPPA">$79.34</td>
					<script>gebi("levelCostDirect").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.levelCostDirect).toFixed(2))</script>
					<script>gebi("levelCostNCREB").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.levelCostNCREB).toFixed(2))</script>
					<script>gebi("levelCostTaxLease").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.levelCostTaxLease).toFixed(2))</script>
					<script>gebi("levelCostTaxEquity").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.levelCostTaxEquity).toFixed(2))</script>
					<script>gebi("levelCostPPA").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.levelCostPPA).toFixed(2))</script>
				</tr>
				<tr>
					<th>Cost per Panel, Community Solar</th>
					<td id="costPanelDirect">$590.92</td>
					<td id="costPanelNCREB">$590.92</td>
					<td id="costPanelTaxLease">$590.92</td>
					<td id="costPanelTaxEquity">$590.92</td>
					<td></td>
					<script>gebi("costPanelDirect").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.costPanelDirect).toFixed(2))</script>
					<script>gebi("costPanelNCREB").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.costPanelNCREB).toFixed(2))</script>
					<script>gebi("costPanelTaxLease").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.costPanelTaxLease).toFixed(2))</script>
					<script>gebi("costPanelTaxEquity").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.costPanelTaxEquity).toFixed(2))</script>
				</tr>
				<tr>
					<th>Cost per 10W of Panel, Community Solar</th>
					<td id="cost10WPanelDirect">$19.37</td>
					<td id="cost10WPanelNCREB">$19.37</td>
					<td id="cost10WPanelTaxLease">$19.37</td>
					<td id="cost10WPanelTaxEquity">$19.37</td>
					<td></td>
					<script>gebi("cost10WPanelDirect").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.cost10WPanelDirect).toFixed(2))</script>
					<script>gebi("cost10WPanelNCREB").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.cost10WPanelNCREB).toFixed(2))</script>
					<script>gebi("cost10WPanelTaxLease").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.cost10WPanelTaxLease).toFixed(2))</script>
					<script>gebi("cost10WPanelTaxEquity").innerHTML = "$" + delimitNumbers(parseFloat(allOutputData.cost10WPanelTaxEquity).toFixed(2))</script>
				</tr>
			</table>
		</div>
		<p class="reportTitle postRun">Simulation Location</p>
		<div id="locationReport" class="tightContent postRun">
			<div id="mapHere"></div>
			<script type="text/javascript">
				width = 1000, height = 350
				projection = d3.geo.albersUsa().scale(600).translate([width/2, height/2])
				path = d3.geo.path()
					.projection(projection)
				svg = d3.select("#mapHere").append("svg")
					.attr("width", width)
					.attr("height", height)
				group = svg.append("g")
				group.attr("transorm", "scale(.2, .2)")
				d3.json('{{pathPrefix}}/static/state_boundaries.json', function(collection) {
					group.selectAll('path')
						.data(collection.features)
						.enter().append('path')
						.attr('d', d3.geo.path().projection(projection))
						.attr('id', function(d){return d.properties.name.replace(/\s+/g, '')})
						.style('fill', 'gray')
						.style('stroke', 'white')
						.style('stroke-width', 1)})
				d3.json("{{pathPrefix}}/static/city_locations.json", function(new_us_places){
					climate = allInputData.climateName
					ST_NAME = climate.split("-")
					ST = ST_NAME[0], NAME = ST_NAME[1]
					my_coords = projection(new_us_places[ST][NAME])
					r = 5
					circle = svg.append("circle")
						.attr("cx", my_coords[0])
						.attr("cy", my_coords[1])
						.attr("r", 5)
						.attr("class", "HighlightCircle")
					circle.append("svg:title").text(climate)})
			</script>
		</div>
</body>