<head>
  <script type='text/javascript' src='../static/libs/d3.v2.min.js'></script>
  <script type='text/javascript' src='../static/omf.js'></script>
  <link rel='stylesheet' href='../static/omf.css'>
  <style>
  * {border:0px;margin:0px;padding:0px;}
  div#toolbar { 
    padding: 10px;
    height: 25px;
    border-width: 0px 0px 1px 0px;
    border-color:black;
    border-style:solid;
    text-align: center;
    vertical-align: center;
    background-color:black; /* for browsers that can't do gradients */
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#B0B0B0', endColorstr='#696969 '); /* for IE */
    background: -webkit-gradient(linear, left top, left bottom, from(#B0B0B0), to(#696969)); /* for webkit browsers */
    background: -moz-linear-gradient(top,  #B0B0B0,  #696969); /* for firefox 3.6+ */ }
  circle.node {stroke: #fff;stroke-width: 1.5px;}
  line.link {stroke: #999;stroke-opacity: .6;}
  .nodetext {pointer-events: none; font: 10px; }
  circle.selected {stroke: #000; stroke-width: 2px; stroke-opacity: 1.0; }
  circle.highlighted {stroke: #555; stroke-width: 1.5px; stroke-opacity: .8; }
  #selected {border:1px solid black; border-bottom:0px;position:absolute;top:90pt;left:4pt;width:20%;}
  #selected th {background:black; color:white;}
  #selected td {padding:5px; border-bottom:1px solid black; background:white; color:black}
  .leftToolbar {float:left;margin-right:5px;}
  .rightToolbar {float:right; margin-left:5px;}
  </style>
</head>
<body>
<div id='title'>
  <div id='logoBox'><a href='/'>▦</a></div>
  <!--Title:-->Grid Editor: {{model_id}}
</div>
<div id='toolbar'>
  <div class='buttonGroup leftToolbar'>
    <button id='butter' class='pill' onclick='dropPill(this, "Add")'>Add ▾</button>
    <ul class='menu'>
      <li><a href='javascript:newObject({_type:"node",_phases:"",_nominal_voltage:0})'>Node</a></li>
      <li><a href='javascript:newObject({_type:"load",_nominal_voltage:0,_phases:"",_constant_power_A:"",_load_class:""})'>Load</a></li>
      <li><a href='javascript:newObject({_type:"transformer",_phases:"",_nominal_voltage:0})'>Transformer</a></li>
    </ul>
  </div>
  <div class='buttonGroup leftToolbar'>
    <button class='pill' onclick='dropPill(this, "Zoom")'>Zoom ▾</button>
    <ul class='menu'>
      <li><a href='javascript:zoomToFit()'>Zoom to Fit</a></li>
    </ul>
  </div>
  <div class='buttonGroup rightToolbar'>
    <button class='pill' onclick='dropPill(this, "Grid")'>Grid ▾</button>
    <ul class='menu right'>
      <li><a href='javascript:saveModel()'>Save</a></li>
      <li><a href='javascript:history.back()'>Cancel</a></li>
    </ul>
  </div>
</div>
<table id='selected'>
  <thead>
    <tr>
      <th colspan='2'>Selected Component</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<div id='modal_insert'></div>
<div id='chart' style='background:white'></div>
<script>
feeder = '{{model_id}}'

var w = document.width,
    // HACK: subtract off the toolbar and titlebar heights.
    h = document.height - 112,
    tree,
    fill = d3.scale.category20();

var name2nodeIndex = {}

var zoomer = d3.behavior.zoom()

var vis = d3.select('#chart')
	.append('svg:svg')
	.attr('width', w)
	.attr('height', h)
	.attr('pointer-events', 'all')
	.append('svg:g')
	.call(zoomer.on('zoom', zoomRedraw))
	.append('svg:g');

// Need this so we have something to zoom on when we aren't over a node:
vis.append('svg:rect')
	.attr('width', w)
	.attr('height', h)
	.attr('fill', 'white');

var force = d3.layout.force()
  .charge(-120)
  .linkDistance(30)
  .size([w, h]);

force.on('tick', function() {
  vis.selectAll('line.link')
    .attr('x1', function(d) { return d.source.x; })
    .attr('y1', function(d) { return d.source.y; })
    .attr('x2', function(d) { return d.target.x; })
    .attr('y2', function(d) { return d.target.y; });

  vis.selectAll('circle.node')
    .attr('cx', function(d) { return d.x; })
    .attr('cy', function(d) { return d.y; });
});

var nodes = force.nodes()
var links = force.links()

function draw() {
  // Go through the first time and set up the nodes with indices:
  for (x in inputData) {
    if (inputData[x].name != undefined && inputData[x].from == undefined) {
      nodeName = inputData[x].name
      nodeIndex = nodes.length
      nodes.push({name:nodeName,treeIndex:parseInt(x)})
      name2nodeIndex[nodeName] = nodeIndex
    }
  }
  // Go through a second time and set up the links:
  for (x in inputData) {
    if (inputData[x].name != undefined) {
      if (inputData[x].from != undefined && inputData[x].to != undefined) {
        links.push({source:name2nodeIndex[inputData[x].from],target:name2nodeIndex[inputData[x].to]})
      } else if (inputData[x].parent != undefined) {
        links.push({source:name2nodeIndex[inputData[x].name],target:name2nodeIndex[inputData[x].parent]})
      }
    }
  }
  // This makes a fancy fade-in.
  vis.style('opacity', 1e-6)
    .transition()
    .duration(1500)
    .style('opacity', 1);
  redraw()
}

function redraw() {
  var link = vis.selectAll('line.link')
    .data(links)
      .enter().append('svg:line')
        .attr('class', 'link')
        .style('stroke-width', function(d) { return Math.sqrt(d.value); })
        .attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });
  var node = vis.selectAll('circle.node')
    .data(nodes)
      .enter()
        .append('svg:circle')
        .attr('class', 'node')
        .on('click', onNodeClick)
        .attr('cx', function(d) { return d.x; })
        .attr('cy', function(d) { return d.y; })
        .attr('r', 10)
        .style('fill', function(d) { return fill(d.group); })
        .call(force.drag);
  // TODO: un-comment this to have text labels on _some_ nodes.
  // node.append('svg:title')
  //     .text(function(d) { return d.name; });
  force.start();
};

function zoomRedraw() {
  // Some logging code, if you like:
  // console.log('here', d3.event.translate, d3.event.scale);
  vis.attr('transform',
    'translate(' + d3.event.translate + ')'
    + ' scale(' + d3.event.scale + ')');
}

function onNodeClick(d, i) {
  table = gebi('selected')
  console.log(d,i)
  // TODO: visually identify the selected node.
  // clear the selected table
  tableClear(table)
  treeData = inputData[d.treeIndex]
  for (prop in treeData) {
    row = table.insertRow(-1)
    row.insertCell(0).innerHTML = prop
    row.insertCell(1).innerHTML = treeData[prop]
  }
  row = table.insertRow(-1)
  cell = row.insertCell(0)
  cell.colSpan = 2
  cell.innerHTML = '<button type="button" onclick="editObject(' + i + ')">Edit</button>'
}

function tableClear(table) {
  try {
    while (table.rows.length>1) table.deleteRow(table.rows.length-1)
  }
  catch (err) {
    // Catch: we didn't have any rows.
  }
}

function editObject(index) {
  table = gebi('selected')
  //Make all the boxes editable.
  for (i = 1; i < table.rows.length - 1; i++) {
    cell = table.rows[i].cells[1]
    oldContent = cell.innerHTML
    cell.innerHTML = '<input type="text" name="null" data-old="' + oldContent + '" value="' + oldContent + '"/>'
  }
  //Put the save/cancel buttons in there with the right index.
  table.deleteRow(-1)
  bottomRow = table.insertRow(-1)
  bottomRow.insertCell(0).innerHTML = '<button type="button" onclick="saveEdits(' + index + ')">Save</button>'
  bottomRow.insertCell(1).innerHTML = '<button type="button" onclick="cancelEditing(' + index + ')">Cancel</button>'
}

function saveEdits(index) {
  table = gebi('selected')
  d = inputData[nodes[index].treeIndex]
  for (i = 1; i < table.rows.length - 1; i++) {
    name = table.rows[i].cells[0].innerHTML
    cell = table.rows[i].cells[1]
    newValue = cell.childNodes[0].value
    // alert(name + ':' + newValue)
    d[name] = newValue
    cell.innerHTML = newValue
  }
  table.deleteRow(-1)
  row = table.insertRow(-1)
  cell = row.insertCell(0)
  cell.colSpan = 2
  cell.innerHTML = '<button type="button" onclick="editObject(' + index + ')">Edit</button>'
}

function cancelEditing(index) {
  table = gebi('selected')
  for (i = 1; i < table.rows.length - 1; i++) {
    cell = table.rows[i].cells[1]
    old = cell.childNodes[0].getAttribute('data-old')
    cell.innerHTML = old
  }
  table.deleteRow(-1)
  row = table.insertRow(-1)
  cell = row.insertCell(0)
  cell.colSpan = 2
  cell.innerHTML = '<button type="button" onclick="editObject(' + index + ')">Edit</button>'
}

function newObject(objectDict) {
  objectDict.index = nodes.length 
  objectDict._name = objectDict._type + nodes.length 
  nodes.push(objectDict)
  redraw()
}

function gebi(id) {
  return document.getElementById(id)
}

function zoomToFit() {
  zoomer.translate([0, 0]).scale(1)
  vis.attr('transform', 'translate([0, 0]) scale(1)')
}

function saveModel() {
  sendDict = {nodeList:JSON.stringify(nodes),linkList:JSON.stringify(links),feederName:feeder}
  post_to_url('/saveFeeder/',sendDict)
}

inputData = {"0": {"timezone": "PST+8PDT", "stoptime": "'2000-01-10 00:00:00'", "starttime": "'2000-01-01 00:00:00'", "clock": "clock"}, "1": {"omftype": "#include", "argument": "\"HVAC_schedule.glm\""}, "2": {"omftype": "#include", "argument": "\"water_schedule.glm\""}, "3": {"omftype": "#include", "argument": "\"appliance_schedule.glm\""}, "4": {"omftype": "#define", "argument": "stylesheet=gridlab-d.svn.sourceforge.net/viewvc/gridlab-d/trunk/core/gridlabd-2_0"}, "5": {"omftype": "#set", "argument": "minimum_timestep=60"}, "6": {"omftype": "#set", "argument": "profiler=1"}, "7": {"omftype": "#set", "argument": "relax_naming_rules=1"}, "8": {"omftype": "module", "argument": "tape"}, "9": {"omftype": "module", "argument": "climate"}, "10": {"module": "residential", "implicit_enduses": "NONE"}, "11": {"solver_method": "FBS", "NR_iteration_limit": "50", "module": "powerflow"}, "12": {"omftype": "module", "argument": "market"}, "13": {"object": "stubauction", "name": "Market_1", "period": "300"}, "14": {"property": "current_market.clearing_price", "object": "player", "file": "Price.player", "parent": "Market_1", "loop": "365"}, "15": {"object": "climate", "name": "\"climate\"", "interpolate": "QUADRATIC", "tmyfile": "\"climate.tmy2\""}, "16": {"Control": "MANUAL", "raise_taps": "16", "name": "regulator_configuration_6506321", "band_center": "2401", "Type": "A", "tap_pos_B": "1", "object": "regulator_configuration", "time_delay": "30.0", "connect_type": "1", "regulation": "0.10", "CT_phase": "ABC", "lower_taps": "16", "tap_pos_A": "1", "tap_pos_C": "1", "PT_phase": "ABC", "band_width": "50"}, "17": {"diameter": "0.368", "name": "trip_line_config", "object": "triplex_line_configuration", "conductor_1": "tlc", "conductor_2": "tlc", "conductor_N": "tlc", "insulation_thickness": "0.08"}, "18": {"geometric_mean_radius": "0.01111", "object": "triplex_line_conductor", "name": "tlc", "resistance": "0.97"}, "19": {"impedance1": "0.012000+0.006800j", "name": "fifteen_fifteen_A", "primary_voltage": "4160.0V", "install_type": "POLETOP", "object": "transformer_configuration", "secondary_voltage": "120.0V", "connect_type": "SINGLE_PHASE_CENTER_TAPPED", "shunt_impedance": "1728000+691200j", "impedance2": "0.012000+0.006800j", "impedance": "0.006000+0.013600j", "power_rating": "500"}, "20": {"power_rating": "500", "primary_voltage": "4160", "install_type": "PADMOUNT", "object": "transformer_configuration", "secondary_voltage": "480", "connect_type": "WYE_WYE", "resistance": "0.011", "reactance": "0.02", "name": "transformer_configuration_400"}, "21": {"phases": "ABCN", "name": "n650", "object": "node", "bustype": "SWING", "voltage_B": "-1200.8886-2080.000j", "voltage_C": "-1200.8886+2080.000j", "voltage_A": "2401.7771", "nominal_voltage": "2401.7771"}, "22": {"phases": "ABC", "from": "n650", "name": "Reg1", "object": "regulator", "to": "n630", "configuration": "regulator_configuration_6506321"}, "23": {"phases": "ABCN", "name": "n630", "object": "node", "voltage_B": "-1200.8886-2080.000j", "voltage_C": "-1200.8886+2080.000j", "voltage_A": "2401.7771", "nominal_voltage": "2401.7771"}, "24": {"phases": "AS", "from": "n630", "name": "T1", "object": "transformer", "to": "tn_1", "configuration": "tconf", "groupid": "Distribution_Trans"}, "25": {"name": "tconf", "primary_voltage": "2401.777", "install_type": "POLETOP", "object": "transformer_configuration", "secondary_voltage": "120", "connect_type": "SINGLE_PHASE_CENTER_TAPPED", "shunt_impedance": "10000+10000j", "impedance": "0.00033+0.0022j", "powerA_rating": "110 kVA"}, "26": {"name": "tconf2", "primary_voltage": "2401.777", "install_type": "POLETOP", "object": "transformer_configuration", "secondary_voltage": "120", "connect_type": "SINGLE_PHASE_CENTER_TAPPED", "shunt_impedance": "10000+10000j", "impedance": "0.00033+0.0022j", "powerB_rating": "110 kVA"}, "27": {"phases": "BS", "from": "n630", "name": "T2", "object": "transformer", "to": "tn_2", "configuration": "tconf2", "groupid": "Distribution_Trans"}, "28": {"phases": "AS", "object": "triplex_node", "nominal_voltage": "120", "name": "tn_1"}, "29": {"phases": "BS", "object": "triplex_meter", "nominal_voltage": "120", "name": "tn_2"}, "30": {"phases": "AS", "from": "tn_1", "name": "tl_1", "object": "triplex_line", "to": "tm_1", "length": "100", "configuration": "trip_line_config"}, "31": {"phases": "BS", "from": "tn_2", "name": "t2", "object": "triplex_line", "to": "tm_2", "length": "100", "configuration": "trip_line_config"}, "32": {"phases": "AS", "object": "triplex_meter", "nominal_voltage": "120", "name": "tm_1"}, "33": {"phases": "BS", "object": "triplex_meter", "nominal_voltage": "120", "name": "tm_2"}, "34": {"cooling_system_type": "ELECTRIC", "schedule_skew": "-810", "heating_system_type": "HEAT_PUMP", "name": "house1", "parent": "tm_1", "floor_area": "1838", "cooling_COP": "3.2", "object": "house", "auxiliary_strategy": "LOCKOUT", "aux_heat_temperature_lockout": "2.270706e+001", "heating_setpoint": "heating1*1", "cooling_setpoint": "cooling7*1", "air_temperature": "70", "thermal_integrity_level": "5", "heating_COP": "3.1", "auxiliary_system_type": "ELECTRIC", "mass_temperature": "70", "motor_efficiency": "GOOD", "motor_model": "BASIC"}, "35": {"schedule_skew": "-810", "demand": "water14*1", "name": "waterheater1", "parent": "house1", "object": "waterheater", "heating_element_capacity": "4.8 kW", "thermostat_deadband": "2.9", "location": "INSIDE", "tank_volume": "50", "tank_setpoint": "136.8", "tank_UA": "2.4", "temperature": "135"}, "36": {"parent": "house1", "name": "convenienceLoads1", "power_fraction": "0.100000", "object": "ZIPload", "current_fraction": "0.100000", "base_power": "plug1*2.477490", "impedance_pf": "0.950000", "current_pf": "0.950000", "power_pf": "0.950000", "impedance_fraction": "0.800000", "groupid": "plugload"}, "37": {"parent": "house1", "name": "lights1", "power_fraction": "0.003200", "object": "ZIPload", "current_fraction": "0.425700", "base_power": "lights1*1.616013", "impedance_pf": "1.000000", "current_pf": "-1.000000", "power_pf": "1.000000", "impedance_fraction": "0.571100", "groupid": "lights"}, "38": {"parent": "house1", "name": "television1", "power_fraction": "0.998700", "object": "ZIPload", "current_fraction": "0.039600", "base_power": "television5*0.200598", "impedance_pf": "0.610000", "current_pf": "-0.540000", "power_pf": "-1.000000", "impedance_fraction": "-0.038300", "groupid": "TV"}, "39": {"parent": "house1", "name": "fan1", "power_fraction": "0.013500", "object": "ZIPload", "current_fraction": "0.253400", "base_power": "fan1*0.106899", "impedance_pf": "0.970000", "current_pf": "0.950000", "power_pf": "-1.000000", "impedance_fraction": "0.733200", "groupid": "fan"}, "40": {"cooling_system_type": "ELECTRIC", "heating_system_type": "HEAT_PUMP", "name": "house2", "parent": "tm_2", "floor_area": "1838", "cooling_COP": "3.2", "object": "house", "auxiliary_strategy": "LOCKOUT", "aux_heat_temperature_lockout": "2.270706e+001", "heating_setpoint": "heating1*1", "cooling_setpoint": "cooling7*1", "air_temperature": "70", "thermal_integrity_level": "5", "heating_COP": "3.1", "auxiliary_system_type": "ELECTRIC", "mass_temperature": "70", "motor_efficiency": "GOOD", "motor_model": "BASIC"}, "41": {"schedule_skew": "-810", "demand": "water14*1", "name": "waterheater2", "parent": "house2", "object": "waterheater", "heating_element_capacity": "4.8 kW", "thermostat_deadband": "2.9", "location": "INSIDE", "tank_volume": "50", "tank_setpoint": "136.8", "tank_UA": "2.4", "temperature": "135"}, "42": {"parent": "house2", "name": "convenienceLoads2", "power_fraction": "0.100000", "object": "ZIPload", "current_fraction": "0.100000", "base_power": "plug1*2.477490", "impedance_pf": "0.950000", "current_pf": "0.950000", "power_pf": "0.950000", "impedance_fraction": "0.800000", "groupid": "plugload"}, "43": {"parent": "house2", "name": "lights2", "power_fraction": "0.003200", "object": "ZIPload", "current_fraction": "0.425700", "base_power": "lights1*1.616013", "impedance_pf": "1.000000", "current_pf": "-1.000000", "power_pf": "1.000000", "impedance_fraction": "0.571100", "groupid": "lights"}, "44": {"parent": "house2", "name": "television2", "power_fraction": "0.998700", "object": "ZIPload", "current_fraction": "0.039600", "base_power": "television5*0.200598", "impedance_pf": "0.610000", "current_pf": "-0.540000", "power_pf": "-1.000000", "impedance_fraction": "-0.038300", "groupid": "TV"}, "45": {"parent": "house2", "name": "fan2", "power_fraction": "0.013500", "object": "ZIPload", "current_fraction": "0.253400", "base_power": "fan1*0.106899", "impedance_pf": "0.970000", "current_pf": "0.950000", "power_pf": "-1.000000", "impedance_fraction": "0.733200", "groupid": "fan"}, "46": {"interval": "60", "parent": "Market_1", "object": "recorder", "limit": "14400", "file": "price_statistics.csv", "property": "avg24,std24,last.P,current_market.clearing_price"}, "47": {"interval": "60", "parent": "Reg1", "object": "recorder", "limit": "14400", "file": "Regulator_Reg1.csv", "property": "tap_A,tap_B,tap_C,power_in_A.real,power_in_A.imag,power_in_B.real,power_in_B.imag,power_in_C.real,power_in_C.imag,power_in.real,power_in.imag"}, "48": {"interval": "60", "parent": "tm_1", "object": "recorder", "limit": "14400", "file": "Voltage_tm_1.csv", "property": "voltage_1.real,voltage_1.imag,voltage_2.real,voltage_2.imag,voltage_12.real,voltage_12.imag"}, "49": {"interval": "60", "parent": "tm_2", "object": "recorder", "limit": "14400", "file": "Voltage_tm_2.csv", "property": "voltage_1.real,voltage_1.imag,voltage_2.real,voltage_2.imag,voltage_12.real,voltage_12.imag"}}

tree = inputData

draw()

</script>
</body>
